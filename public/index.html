<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
  <meta name="theme-color" content="#0f0f1a">
  <meta name="description" content="Dona - Asistente de ingenieria estructural metalica">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="Dona">
  <link rel="manifest" href="/manifest.json">
  <link rel="icon" href="/icon-192.svg" type="image/svg+xml">
  <link rel="apple-touch-icon" href="/icon-192.svg">
  <link rel="stylesheet" href="/styles.css">
  <title>Dona</title>
</head>
<body>
  <!-- Header -->
  <header class="header">
    <div class="header-logo">Dona</div>
    <div class="header-text">
      <span class="header-title">Dona</span>
      <span class="header-subtitle">Asistente Estructural</span>
    </div>
    <button class="header-btn" onclick="clearChat()" title="Nueva conversacion">+</button>
  </header>

  <!-- Chat messages -->
  <main class="chat-container" id="chatContainer">
    <div class="welcome">
      <div class="welcome-icon">Dona</div>
      <h2>Hola, soy Dona</h2>
      <p>Tu asistente de ingenieria estructural metalica. Preguntame lo que necesites:</p>
      <div class="welcome-examples">
        <button class="example-btn" onclick="sendExample(this)">Como se calcula el pandeo lateral torsional segun CIRSOC 301?</button>
        <button class="example-btn" onclick="sendExample(this)">Que perfil HEB me conviene para un Mu de 150 kN*m?</button>
        <button class="example-btn" onclick="sendExample(this)">Cuanto cuesta un perfil HEB 200?</button>
        <button class="example-btn" onclick="sendExample(this)">Que dice la norma AWS D1.1 sobre soldadura de filete?</button>
        <button class="example-btn" onclick="sendExample(this)">Busca perfiles IPE con Wx mayor a 500 cm3</button>
        <button class="example-btn" onclick="sendExample(this)">Explicame el diseno de placas base segun AISC</button>
      </div>
    </div>
  </main>

  <!-- Input area -->
  <footer class="input-area">
    <div class="input-wrapper">
      <textarea
        id="messageInput"
        placeholder="Escribi tu consulta..."
        rows="1"
        onkeydown="handleKeyDown(event)"
        oninput="autoResize(this)"
      ></textarea>
      <button class="send-btn" id="sendBtn" onclick="sendMessage()">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <line x1="22" y1="2" x2="11" y2="13"></line>
          <polygon points="22 2 15 22 11 13 2 9 22 2"></polygon>
        </svg>
      </button>
    </div>
  </footer>

  <script>
    const chatContainer = document.getElementById('chatContainer');
    const messageInput = document.getElementById('messageInput');
    const sendBtn = document.getElementById('sendBtn');
    let history = [];
    let isLoading = false;

    function handleKeyDown(e) {
      if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        sendMessage();
      }
    }

    function autoResize(el) {
      el.style.height = 'auto';
      el.style.height = Math.min(el.scrollHeight, 120) + 'px';
    }

    function sendExample(btn) {
      messageInput.value = btn.textContent;
      sendMessage();
    }

    function clearChat() {
      history = [];
      chatContainer.innerHTML = `
        <div class="welcome">
          <div class="welcome-icon">Dona</div>
          <h2>Hola, soy Dona</h2>
          <p>Tu asistente de ingenieria estructural metalica. Preguntame lo que necesites.</p>
        </div>`;
    }

    async function sendMessage() {
      const text = messageInput.value.trim();
      if (!text || isLoading) return;

      // Ocultar welcome
      const welcome = chatContainer.querySelector('.welcome');
      if (welcome) welcome.remove();

      // Agregar mensaje del usuario
      appendMessage('user', text);
      history.push({ role: 'user', content: text });

      messageInput.value = '';
      messageInput.style.height = 'auto';
      isLoading = true;
      sendBtn.disabled = true;

      // Mostrar indicador de carga
      const loadingEl = appendLoading();

      try {
        const res = await fetch('/api/chat', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ message: text, history: history.slice(0, -1) }),
        });

        const data = await res.json();

        loadingEl.remove();

        if (data.error) {
          appendMessage('assistant', 'Error: ' + data.error);
        } else {
          appendMessage('assistant', data.response);
          history.push({ role: 'assistant', content: data.response });
        }
      } catch (err) {
        loadingEl.remove();
        appendMessage('assistant', 'Error de conexion. Verifica que el servidor este corriendo.');
      } finally {
        isLoading = false;
        sendBtn.disabled = false;
        messageInput.focus();
      }
    }

    function appendMessage(role, content) {
      const div = document.createElement('div');
      div.className = 'message message-' + role;

      const bubble = document.createElement('div');
      bubble.className = 'bubble bubble-' + role;

      if (role === 'assistant') {
        bubble.innerHTML = formatMarkdown(content);
      } else {
        bubble.textContent = content;
      }

      div.appendChild(bubble);
      chatContainer.appendChild(div);
      chatContainer.scrollTop = chatContainer.scrollHeight;
    }

    function appendLoading() {
      const div = document.createElement('div');
      div.className = 'message message-assistant';
      div.innerHTML = '<div class="bubble bubble-assistant loading-bubble"><span class="dot"></span><span class="dot"></span><span class="dot"></span></div>';
      chatContainer.appendChild(div);
      chatContainer.scrollTop = chatContainer.scrollHeight;
      return div;
    }

    function formatMarkdown(text) {
      // Escape HTML first
      let html = text
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;');

      // Bold: **text**
      html = html.replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>');

      // Inline code: `code`
      html = html.replace(/`([^`]+)`/g, '<code>$1</code>');

      // Code blocks: ```code```
      html = html.replace(/```(\w*)\n?([\s\S]*?)```/g, '<pre><code>$2</code></pre>');

      // Headers
      html = html.replace(/^### (.+)$/gm, '<h4>$1</h4>');
      html = html.replace(/^## (.+)$/gm, '<h3>$1</h3>');

      // Lists
      html = html.replace(/^\- (.+)$/gm, '<li>$1</li>');
      html = html.replace(/^(\d+)\. (.+)$/gm, '<li>$2</li>');

      // Wrap consecutive <li> in <ul>
      html = html.replace(/((?:<li>.*<\/li>\n?)+)/g, '<ul>$1</ul>');

      // Line breaks
      html = html.replace(/\n\n/g, '</p><p>');
      html = html.replace(/\n/g, '<br>');

      return '<p>' + html + '</p>';
    }

    // Service Worker
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('/sw.js').catch(() => {});
    }

    // Focus input on load
    messageInput.focus();
  </script>
</body>
</html>
